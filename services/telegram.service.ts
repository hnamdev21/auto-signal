import TelegramBot from "node-telegram-bot-api";
import { AlertData, TradingSignal } from "../types/market.model";
import { getRSISignal } from "../utils/rsi.utils";

export class TelegramService {
  private bot: TelegramBot;
  private chatId: string;

  constructor(botToken: string, chatId: string) {
    this.bot = new TelegramBot(botToken, { polling: false });
    this.chatId = chatId;
  }

  /**
   * Send a simple text message
   */
  async sendMessage(message: string): Promise<void> {
    try {
      await this.bot.sendMessage(this.chatId, message, {
        parse_mode: "HTML",
        disable_web_page_preview: true,
      });
    } catch (error) {
      console.error("Error sending Telegram message:", error);
      throw error;
    }
  }

  /**
   * Send price and RSI alert
   */
  async sendPriceAlert(alertData: AlertData): Promise<void> {
    const { symbol, currentPrice, rsi, timestamp, timeframe } = alertData;
    const rsiSignal = getRSISignal(rsi);
    const time = new Date(timestamp).toISOString();

    const message = `
ğŸ“Š <b>Price Alert - ${symbol}</b>

ğŸ’° <b>Current Price:</b> ${currentPrice.toLocaleString()} USDT
ğŸ“ˆ <b>RSI (${timeframe}):</b> ${rsi} ${rsiSignal}
ğŸ• <b>Time:</b> ${time}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<i>Alert generated by Signals Bot</i>
    `.trim();

    await this.sendMessage(message);
  }

  /**
   * Send bot startup notification
   */
  async sendStartupMessage(): Promise<void> {
    const message = `
ğŸš€ <b>RSI Divergence Bot Started</b>

âœ… Bot is now monitoring market data
â° Executing every minute (UTC)
ğŸ¯ <b>Divergence Detection: ENABLED</b>
ğŸ“Š Tracking: Price + RSI divergence signals
ğŸ”„ Real-time data from Binance API
ğŸ“± <b>Alerts: Only for divergence signals</b>

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<i>Bot started at: ${new Date().toISOString()}</i>
    `.trim();

    await this.sendMessage(message);
  }

  /**
   * Send error notification
   */
  async sendErrorMessage(error: string, context?: string): Promise<void> {
    const message = `
âŒ <b>Bot Error</b>

${context ? `<b>Context:</b> ${context}\n` : ""}
<b>Error:</b> ${error}
ğŸ• <b>Time:</b> ${new Date().toISOString()}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<i>Please check the bot logs for more details</i>
    `.trim();

    await this.sendMessage(message);
  }

  /**
   * Send health check message
   */
  async sendHealthCheck(): Promise<void> {
    const message = `
ğŸ’š <b>Bot Health Check</b>

âœ… Bot is running normally
ğŸ• Last check: ${new Date().toISOString()}
    `.trim();

    await this.sendMessage(message);
  }

  /**
   * Send trading signal with divergence detection
   */
  async sendTradingSignal(signal: TradingSignal): Promise<void> {
    const {
      symbol,
      currentPrice,
      rsi,
      divergenceSignal,
      timestamp,
      timeframe,
    } = signal;
    const rsiSignal = getRSISignal(rsi);
    const time = new Date(timestamp).toISOString();

    let message = `
ğŸ“Š <b>Trading Signal - ${symbol}</b>

ğŸ’° <b>Current Price:</b> ${currentPrice.toLocaleString()} USDT
ğŸ“ˆ <b>RSI (${timeframe}):</b> ${rsi} ${rsiSignal}
ğŸ• <b>Time:</b> ${time}
    `;

    // Add divergence signal if present
    if (divergenceSignal) {
      const signalType =
        divergenceSignal.type === "BULLISH" ? "ğŸŸ¢ BULLISH" : "ğŸ”´ BEARISH";
      const strength =
        divergenceSignal.confidence >= 80
          ? "ğŸ”¥ STRONG"
          : divergenceSignal.confidence >= 60
          ? "âš¡ MEDIUM"
          : divergenceSignal.confidence >= 40
          ? "ğŸ’¡ WEAK"
          : "â“ VERY WEAK";

      message += `

ğŸ¯ <b>DIVERGENCE SIGNAL DETECTED!</b>
${signalType} DIVERGENCE ${strength}

ğŸ“Š <b>Entry Price:</b> ${divergenceSignal.price.toLocaleString()} USDT
ğŸ“ˆ <b>RSI at Signal:</b> ${divergenceSignal.rsi.toFixed(2)}
ğŸ¯ <b>Take Profit:</b> ${divergenceSignal.takeProfit.toLocaleString()} USDT
ğŸ›¡ï¸ <b>Stop Loss:</b> ${divergenceSignal.stopLoss.toLocaleString()} USDT
ğŸ“Š <b>Confidence:</b> ${divergenceSignal.confidence.toFixed(1)}%

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<i>âš ï¸ This is not financial advice. Trade at your own risk.</i>
      `;
    } else {
      message += `

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<i>Alert generated by Signals Bot</i>
      `;
    }

    await this.sendMessage(message.trim());
  }

  /**
   * Test if the bot can send messages
   */
  async testConnection(): Promise<boolean> {
    try {
      await this.sendMessage("ğŸ§ª Bot connection test successful!");
      return true;
    } catch (error) {
      console.error("Telegram connection test failed:", error);
      return false;
    }
  }
}
